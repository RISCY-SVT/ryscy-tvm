# TVM для LicheePi4A с поддержкой RISC-V векторных расширений

Этот проект настраивает полноценную систему сборки [Apache TVM](https://tvm.apache.org/) с поддержкой LLVM для конвертации и оптимизации моделей нейронных сетей (таких как YOLOv5n и DeepAnythingV2) для выполнения на процессоре TH1520 (LicheePi4A), с полным задействованием векторных расширений RISC-V.

## Цели проекта

- Создание среды для компиляции нейросетей под архитектуру RISC-V с векторными расширениями
- Обеспечение совместимости с процессором TH1520 (Thead C906) на плате LicheePi4A
- Достижение максимальной производительности при инференсе с использованием векторных расширений
- Обеспечение расширяемости для поддержки других RISC-V процессоров в будущем

## Особенности

- Использование новой версии TVM (>=0.20.0) с API Relax (вместо устаревшего Relay)
- Собственная сборка LLVM 20.x с полной поддержкой RISC-V векторных расширений
- Docker-контейнер для изоляции и воспроизводимости всего процесса сборки
- Поддержка кросс-компиляции runtime библиотеки для RISC-V
- Оптимизированная сборка для процессора TH1520 (Thead C906)

## Структура проекта

```
├── Dockerfile            # Образ Docker с необходимыми зависимостями
├── docker-compose.yml    # Конфигурация для запуска контейнера
├── build-docker.sh       # Скрипт для сборки Docker-образа
├── run-docker.sh         # Скрипт для запуска Docker-контейнера
├── env.sh                # Переменные окружения для всех скриптов
├── .env                  # Переменные окружения для Docker
├── scripts/              # Скрипты для сборки компонентов
│   ├── 00-build-llvm-rvv.sh      # Сборка LLVM с поддержкой RISC-V Vector Extensions
│   ├── 01-tvm_build.sh           # Сборка TVM для хост-системы (x86_64)
│   ├── 02_build_runtime.sh       # Сборка TVM runtime для RISC-V
│   ├── config.cmake.host         # Конфигурация CMake для сборки TVM на хосте
│   └── config.cmake.lichee       # Конфигурация CMake для сборки TVM runtime для LicheePi4A
└── data/                 # Директория для исходников TVM и результатов сборки (монтируется из Docker)
```

## Требования

- Docker и docker-compose
- Linux-система с поддержкой контейнеризации
- Не менее 8 ГБ ОЗУ (рекомендуется 16+ ГБ) для сборки LLVM и TVM
- Не менее 30 ГБ свободного места на диске

## Установка и использование

### 1. Клонирование репозитория

```bash
git clone https://github.com/Custler/riscy-tvm.git
cd riscy-tvm
```

### 2. Сборка Docker-образа

```bash
./build-docker.sh
```

### 3. Запуск Docker-контейнера

```bash
./run-docker.sh
```

### 4. Сборка LLVM с поддержкой RISC-V Vector Extensions

Внутри контейнера:

```bash
cd /workspace/scripts
./00-build-llvm-rvv.sh
```

Это скомпилирует LLVM 20.x с поддержкой RISC-V векторных расширений. Процесс займет значительное время.

### 5. Сборка TVM для хост-системы

```bash
./01-tvm_build.sh
```

Этот скрипт соберет TVM с поддержкой нового API Relax для хост-системы (x86_64).

### 6. Сборка TVM runtime для RISC-V

```bash
./02_build_runtime.sh
```

Скрипт скомпилирует runtime библиотеку TVM для RISC-V, оптимизированную для процессора TH1520 с использованием векторных расширений.

## Достигнутые результаты

- ✅ Успешная сборка TVM 0.21.dev0 с поддержкой Relax API
- ✅ Полная интеграция с LLVM 20.x для оптимальной кодогенерации
- ✅ Поддержка RISC-V векторных расширений ("+v") для процессора TH1520 (Thead C906)
- ✅ Возможность кросс-компиляции runtime библиотеки для RISC-V
- ✅ Создание Python wheel пакета для хостовой части TVM
- ✅ Полная автоматизация процесса сборки через Docker

## Использование TVM для компиляции моделей

После сборки всех компонентов, вы можете использовать TVM для компиляции моделей нейронных сетей для LicheePi4A следующим образом:

```python
import tvm
from tvm import relax
from tvm.target import Target

# Определение target для LicheePi4A (TH1520, Thead C906)
target = Target("llvm -mtriple=riscv64-unknown-linux-gnu -mcpu=thead-c906 -mattr=+v")

# Загрузка модели и компиляция через Relax API
# (Пример с конкретной моделью будет добавлен позже)
```

## Планы по развитию

- [ ] Добавление примеров конвертации конкретных моделей (YOLOv5n, DeepAnythingV2)
- [ ] Оптимизация параметров компиляции для максимальной производительности на LicheePi4A
- [ ] Расширение поддержки для других RISC-V процессоров
- [ ] Интеграция с TVM Auto-Tuning для автоматического поиска оптимальных параметров
- [ ] Добавление бенчмарков для сравнения производительности

## Лицензия

Этот проект распространяется под лицензией Apache License 2.0.
